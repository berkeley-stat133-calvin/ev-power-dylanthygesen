---
Author: Dylan Thygesen
title: "EV Power - Lab 4 Project Report - Finding which states are trending towards a renewable energy future"
format: typst
---

# Example Solution 1

## **Part 0: libraries**

```{r} 
library(tidyverse)
library(rnaturalearth)
library(leaflet)
library(sf)
library(maps)
```

## **Part 1:** **Defining Research Question**
Some questions I brainstormed include:
1.) Which states increased / decreased their usage of renewable energy between 2021 and 2023?
2.) Is there a correlation between states with a higher average energy price having a greater share of their energy coming from renewable sources?
3.) Which energy source most frequently was the most used in a state, and is there a correlation between which energy source was used most in a state and their EV registration count?
4.) Is there a correlation between EV Registration Count and Average Energy Price?

Chosen Question: Wanted to do 2, but ended up finding no meaningful relationship, so looking at qiestion 1 for the map. Looking to see which states are on the rise in increasing their reusable energy, and which are decreasing and moving towards other options. 



## **Part 2: Data Preparation and Cleaning**

```{r}
av_price_raw<-read_csv("data/av-energy-price-2021-2023.csv",col_names=FALSE)|>
separate(X1,into=c("state","2021_av","2022_av","2023_av"),sep=",")
av_price_clean<-av_price_raw|>
    mutate(across(.cols=c("2021_av","2022_av","2023_av"),.fns=~as.numeric(str_extract(.x,"[-.0-9]+"))))|>
    mutate(state=str_to_lower(state))|>
    slice(-(1:3))|>
    slice(-52)

head(av_price_clean)

state_name_to_abb_map <- setNames(state.abb, state.name) #Found, used to streamline changing full state names to their abbreviated form through matching. 

ev_count_raw<-read_csv("data/ev-registrations-by-state-2023.csv",col_names=FALSE)
ev_count_clean<-ev_count_raw|>
slice(-(1:3))|>
mutate(state_name = str_to_lower(state_name_to_abb_map[X1])) |>
       mutate(ev_count=as.numeric(str_extract(X2,"[-.0-9]+"))) |>
       select(-X1)|>
       select(-X2)|>
       slice(-52)

head(ev_count_clean)

total_use_2021_raw <- read_csv("data/total-use-2021.csv")
total_use_2021_clean<-total_use_2021_raw|>
    rename_with(str_to_lower)|>
    pivot_longer(cols=-energy_source,names_to="state",values_to = "total_use_2021")|>
    arrange(state)|>
    filter(state != "us")|>
     mutate(energy_source = case_when(
    str_detect(energy_source, "coal|Coal") ~ "coal",
    str_detect(energy_source, "natural_gas|natural gas|Natural Gas|NaturalGas") ~ "natural_gas",
    str_detect(energy_source, "petroleum|Petro") ~ "petroleum",
    str_detect(energy_source, "nuclear|Nuclear") ~ "nuclear",
    str_detect(energy_source, "renewable") ~ "renewables"))

head(total_use_2021_clean)

total_use_2022_raw <- read_csv("data/total-use-2022.csv")
total_use_2022_clean<-total_use_2022_raw|>
    rename_with(str_to_lower)|>
    pivot_longer(cols=-energy_source,names_to="state",values_to = "total_use_2022")|>
    arrange(state)|>
    filter(state != "us")|>
     mutate(energy_source = case_when(
    str_detect(energy_source, "coal| Coal") ~ "coal",
    str_detect(energy_source, "natural_gas|natural gas|Natural Gas|NaturalGas|Natural-Gas") ~ "natural_gas",
    str_detect(energy_source, "petroleum|Petro") ~ "petroleum",
    str_detect(energy_source, "nuclear|Nuclear") ~ "nuclear",
    str_detect(energy_source, "renewable") ~ "renewables"))

head(total_use_2022_clean)

total_use_2023_raw <- read_csv("data/total-use-2023.csv")
total_use_2023_clean<-total_use_2023_raw|>
    rename_with(str_to_lower)|>
    pivot_longer(cols=-energy_source,names_to="state",values_to = "total_use_2023")|>
    arrange(state)|>
    filter(state != "us")|>
     mutate(energy_source = case_when(
    str_detect(energy_source, "coal|Coal") ~ "coal",
    str_detect(energy_source, "natural_gas|natural gas|Natural Gas|NaturalGas") ~ "natural_gas",
    str_detect(energy_source, "petroleum|Petro") ~ "petroleum",
    str_detect(energy_source, "nuclear|Nuclear") ~ "nuclear",
    str_detect(energy_source, "renewable") ~ "renewables"))

head(total_use_2023_clean)

renew_use_2021_raw <- read_csv("data/renew-use-2021.csv")
renew_use_2021_clean <- renew_use_2021_raw |>
  rename_with(str_to_lower)|>
  mutate(state = str_to_lower(state),
renewable_use_2021 = as.numeric(str_extract(renewable_use_2021, "[-.0-9]+")))|>
    slice(-(256:260))

head(renew_use_2021_clean)

renew_use_2022_raw <- read_csv("data/renew-use-2022.csv")
renew_use_2022_clean <- renew_use_2022_raw |>
  rename_with(str_to_lower)|>
  mutate(state = str_to_lower(state),
renewable_use_2021 = as.numeric(str_extract(renewable_use_2022, "[-.0-9]+")))|>
    slice(-(256:260))

head(renew_use_2022_clean)

renew_use_2023_raw <- read_csv("data/renew-use-2023.csv")
renew_use_2023_clean <- renew_use_2023_raw |>
  rename_with(str_to_lower)|>
  mutate(state = str_to_lower(state),
renewable_use_2023 = as.numeric(str_extract(renewable_use_2023, "[-.0-9]+")))|>
    slice(-(256:260))

head(renew_use_2023_clean)
```

## **Part 3:Pivots / Joining
```{r}
# Research Question 1: percentage increase or decrease in renewable energy used between 2021 and 2023. 
total_use_2021_2022<-full_join(total_use_2021_clean,total_use_2022_clean,by=c("state","energy_source"))
total_use_all_renewable<-full_join(total_use_2021_2022,total_use_2023_clean,by=c("state","energy_source"))|>
    mutate(percentage_change=(total_use_2023-total_use_2021)/total_use_2021*100)|>
    filter(energy_source=="renewables")

head(total_use_all_renewable)

#Research Question 2:Is there a correlation between states with a higher average energy price having a greater share of their energy coming from renewable sources? (Using 2023 data opposed to averages from across all 3 years)
renewable_share_2023<-total_use_2023_clean|>
    group_by(state)|>
    mutate(total_use_by_state=sum(total_use_2023,na.rm=TRUE))|>
    ungroup()|>
    filter(energy_source=="renewables")|>
    mutate(renewable_share=total_use_2023/total_use_by_state*100)|>
    select(state,renewable_share)

head(renewable_share_2023)

question_2_data<-full_join(av_price_clean,renewable_share_2023,by="state")|>
    select("state","renewable_share","2023_av")

head(question_2_data)

correlation<-question_2_data|>
    summarize(core_value=cor(renewable_share,`2023_av`))|>
    print()

#There is little to no correlation between a states average price of energy and thee share of their energy production coming from renewable energy. 







```

## **Part 4: Mapping Visualization**

```{r}
state_map_data<-map("state", fill = TRUE, plot = FALSE)
states_sf_raw <- st_as_sf(state_map_data)
state_name_to_abb_map <- setNames(state.abb, state.name)
state_abb_lowercase<-tolower(state.abb)
state_lookup <- data.frame(ID = tolower(state.name), state = state_abb_lowercase)
states_sf_clean <- states_sf_raw |>
    left_join(state_lookup, by = "ID") |>
    select(state, geom) 
map_data_joined<-states_sf_clean|>
    left_join(total_use_all_renewable,by="state")

head(map_data_joined)

map<-ggplot(map_data_joined)+geom_sf(aes(fill=percentage_change,))+ scale_fill_distiller(palette="RdYlGn",name="Percent Change",direction=1)+
    labs(title="Change in Share of Renewable Energy as a Percent of Total Energy Output between 2021 and 2023")+theme_void()+theme(plot.title=element_text(size=6.5,color="dodgerblue"),legend.title=element_text(size=5,color="dodgerblue"))
print(map)
## Analyzing this map, we can see California, New Mexico, Nevada, and Texas lead the way with increasing their energy output coming from renewable sources. On the other hand, Tennesee, Washington, Virgina, Maine, and Florida have increased their usage of non-renewable energy sources since 2021.
```